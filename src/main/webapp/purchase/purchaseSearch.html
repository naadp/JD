<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>进货单据查询</title>
<link rel="stylesheet" type="text/css" href="/JD/static/jquery-easyui-1.3.3/themes/default/easyui.css"></link>
<link rel="stylesheet" type="text/css" href="/JD/static/jquery-easyui-1.3.3/themes/icon.css"></link>
<script type="text/javascript" src="/JD/static/jquery-easyui-1.3.3/jquery.min.js"></script>
<script type="text/javascript" src="/JD/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
<script type="text/javascript" src="/JD/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>

<script type="text/javascript" src="/JD/static/js/date.js"></script>
<script type="text/javascript">

    //PurchaseList类 加了两个日期属性, 不映射到数据库, 仅仅是为了比较时间而已.
    //查询进货订单时没有分页的, 而且根据日期逆序排序, 这里不能根据id来排序,
	//因为商户希望是时间排序, id排序太没经验了，用户体验太差了
    //在查询进货单的页面, 我们显示的是所有的进货单, 并没有分页,
	//然后为了提高用户体验, 把两个日期控件设置好时间: 从 上个月的今天 至 今天.
	//还是为了提高用户体验, 进货商大下拉框可以手动输入字符, 输入后就会进行查询;
	//输入单据号之后, 按回车键也会立刻模糊查询.
	//不知道为什么, date.js 中获取上个月今天的函数返回的日期不太正确,
	//于是在网上又找了个函数

	function formatUser(val,row){
		return val.trueName+"&nbsp;("+val.userName+")&nbsp;";
	}

    function genLastMonthDayStr(){

        var now=new Date();
        var year = now.getFullYear();//getYear()+1900=getFullYear()
        var month = now.getMonth() +1;//0-11表示1-12月
        var day = now.getDate();
        if(parseInt(month)<10){
            month="0"+month;
        }
        if(parseInt(day)<10){
            day="0"+day;
        }

        now =year + '-'+ month + '-' + day;

        if (parseInt(month) ==1) {//如果是1月份，则取上一年的12月份
            return (parseInt(year) - 1) + '-12-' + day;
        }

        var  preSize= new Date(year, parseInt(month)-1, 0).getDate();//上月总天数
        if (preSize < parseInt(day)) {//上月总天数<本月日期，比如3月的30日，在2月中没有30
            return year + '-' + month + '-01';
        }

        if(parseInt(month) <=10){
            return year + '-0' + (parseInt(month)-1) + '-' + day;
        }else{
            return year + '-' + (parseInt(month)-1) + '-' + day;
        }

    }
	
	function searchPurchase(){
		$("#dg2").datagrid("loadData",{total:0,rows:[]});
		var supplierId;
		if(isNaN($("#s_supplier").combobox("getValue"))){
			supplierId="";
		}else{
			supplierId=$("#s_supplier").combobox("getValue");
		}
		$("#dg").datagrid({
			url:'/JD/admin/purchaseList/list',
			queryParams:{
				purchaseNumber:$("#s_purchaseNumber").val(),
				"supplier.id":supplierId,
				state:$("#s_state").combobox("getValue"),
				bPurchaseDate:$("#s_bPurchaseDate").datebox("getValue"),
				ePurchaseDate:$("#s_ePurchaseDate").datebox("getValue")
			}
		});
	}
	
	function formatSupplier(val,row){
		return val.name;
	}
	
	function formatAmountPayable(val,row){
		return "¥"+val;
	}
	
	function formatUser(val,row){
		return val.trueName;
	}
	
	function deletePurchase(){
		var selectedRows=$("#dg").datagrid("getSelections");
		if(selectedRows.length!=1){
			$.messager.alert("系统提示","请选择一条要删除的进货单！");
			return;
		}
		var id=selectedRows[0].id;
		$.messager.confirm("系统提示","<font color=red>删除进货单后将无法恢复，是否删除?</font>",function(r){
			if(r){
				$.post("/JD/admin/purchaseList/delete",{id:id},function(result){
					if(result.success){
						$("#dg").datagrid("reload");
						$("#dg2").datagrid("reload");
					}else{
						$.messager.alert("系统提示",result.errorInfo);
					}
				},"json");
			}
		});
	}
	
	
	$(document).ready(function() {

        $("#s_supplier").combobox({
            mode:'remote',
            url:'/JD/admin/supplier/comboList',
            valueField:'id',
            textField:'name',
            delay:100
        });
		
		$("#s_bPurchaseDate").datebox("setValue",genLastMonthDayStr()); // 设置上个月日期
		$("#s_ePurchaseDate").datebox("setValue",genTodayStr()); // 设置当前日期
		
		$("#dg").datagrid({
			onClickRow:function(index,row){
				$("#dg2").datagrid({
					url:'/JD/admin/purchaseList/listGoods',
					queryParams:{
						purchaseListId:row.id
					}
				});
			}
		});
		
	});
	
	
	function formatPrice(val,row){
		return "¥"+val;
	}
	
	function formatTotal(val,row){
		return "¥"+val;
	}
</script>
</head>
<body class="easyui-layout" style="margin: 1px">
 <div region="north" style="height: 350px">
	<table id="dg" title="进货单据查询" class="easyui-datagrid"
	fitColumns="true"  rownumbers="true" singleSelect="true"
	 fit="true" toolbar="#tb">
		<thead>
			<th field="id" width="20" align="center" hidden="true">进货单ID</th>
			<th field="purchaseNumber" width="30" align="center">进货单号</th>
			<th field="purchaseDate" width="20" align="center">进货日期</th>
			<th field="supplier" width="50" align="center" formatter="formatSupplier">供应商</th>
			<th field="amountPayable" width="20" align="right" formatter="formatAmountPayable">进货金额</th>
			<th field="user" width="20" align="center" formatter="formatUser">操作员</th>
			<th field="remarks" width="100" align="center">备注</th>
		</thead>
	</table>
	
	<div id="tb">
		<fieldset style="border-color: #E7F0FF">
			<legend>查询设置</legend>
			&nbsp;单据号&nbsp;
			<input type="text" id="s_purchaseNumber" size="15" onkeydown="if(event.keyCode==13) searchPurchase()"/>
			&nbsp;&nbsp;&nbsp;供应商：&nbsp;<input class="easyui-combobox" id="s_supplier" name="supplier.id" style="width: 200px" required="true" data-options="required:true,panelHeight:'auto',valueField:'id',textField:'name',url:'/JD/admin/supplier/comboList'"/>
			&nbsp;&nbsp;&nbsp;是否付款&nbsp;
			<select class="easyui-combobox" id="s_state" style="width: 100px" editable="false" panelHeight="auto">
				<option value="">全部</option>
				<option value="1">已付</option>
				<option value="2">未付</option>
			</select>
			&nbsp;&nbsp;&nbsp;日期：&nbsp;
			<input id="s_bPurchaseDate" class="easyui-datebox" editable=false style="width:100px"/>
			&nbsp;&nbsp;-&nbsp;&nbsp;
			<input id="s_ePurchaseDate" class="easyui-datebox" editable=false style="width:100px"/>
			&nbsp;&nbsp;<a href="javascript:searchPurchase()" class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
			&nbsp;&nbsp;<a href="javascript:deletePurchase()" class="easyui-linkbutton" iconCls="icon-remove" plain="true">删除</a>
		</fieldset>
	</div>
 </div>
 <div region="center" style="margin-top: 5px">
     <table id="dg2"  class="easyui-datagrid"
		fitColumns="true"  rownumbers="true" singleSelect="true"
		 fit="true" >
			<thead>
				<th field="code" width="30" align="center">商品编码</th>
				<th field="name" width="150" align="center">商品名称</th>
				<th field="model" width="50" align="center">商品型号</th>
				<th field="price" width="50" align="right" formatter="formatPrice">单价</th>
				<th field="num" width="50" align="center">数量</th>
				<th field="unit" width="50" align="center">单位</th>
				<th field="total" width="50" align="right" formatter="formatTotal">总金额</th>
			</thead>
	</table>
   
 </div>	

</body>
</html>